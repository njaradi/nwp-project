<div class="container mt-4">

  <!-- Filter Row -->
  <div class="row g-2 mb-3 align-items-center">
    <div class="col-md-3">
      <input type="text" class="form-control" placeholder="Filter by name" [(ngModel)]="filterName">
    </div>

    <div class="col-md-2">
      <select class="form-select" [(ngModel)]="filterState">
        <option value="">All states</option>
        <option *ngFor="let s of states" [value]="s">{{ s }}</option>
      </select>
    </div>

    <div class="col-md-3">
      <input type="date" class="form-control" [(ngModel)]="filterDateFrom" placeholder="From date">
    </div>

    <div class="col-md-3">
      <input type="date" class="form-control" [(ngModel)]="filterDateTo" placeholder="To date">
    </div>
  </div>

  <!-- Add VM Row -->
  <div class="d-flex align-items-center gap-2 mb-4">
    <button class="btn btn-secondary" (click)="showAddForm = !showAddForm">
      {{ showAddForm ? 'Cancel' : 'New Machine' }}
    </button>

    <div class="add-form" [class.show]="showAddForm">
      <input type="text"
             class="form-control"
             placeholder="Machine name"
             [(ngModel)]="newVmName"
             (keyup.enter)="addVm()" />
      <button class="btn btn-primary" (click)="addVm()">Create</button>
    </div>
  </div>


  <!-- VM Grid -->
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
    <div *ngFor="let vm of filteredVmList" class="col">
      <div class="card h-100 border border-2 position-relative"
           [ngClass]="{
             'border-primary': vm.state === 'Running',
             'border-danger': vm.state === 'Crashed',
             'border-secondary': vm.state === 'Stopped',
             'border-warning': vm.state === 'Restarting',
             'border-info': vm.state === 'Turning off',
             'border-success': vm.state ==='Turning on'
           }">

        <div class="card-body">
          <h5 class="card-title">{{ vm.name }}</h5>
          <p class="card-text mb-1"><strong>State:</strong> {{ vm.state }}</p>
          <p class="card-text"><strong>Date:</strong> {{ vm.date }}</p>

          <div class="d-flex flex-wrap gap-2">
            <button *ngIf="isStopped(vm)" class="btn btn-outline-success btn-sm" (click)="turnon(vm)">Turn on</button>
            <button *ngIf="isRunning(vm)" class="btn btn-outline-secondary btn-sm" (click)="shutdown(vm)">Shut Down</button>
            <button *ngIf="isRunning(vm)" class="btn btn-outline-info btn-sm" (click)="restart(vm)">Restart</button>
            <button class="btn btn-outline-primary btn-sm" (click)="openScheduleModal(vm)">Schedule</button>
          </div>
          <!-- Scheduled tasks -->
          <div *ngIf="scheduledTasks[vm.id]?.length" class="mt-2">
            <small *ngFor="let task of scheduledTasks[vm.id]" class="d-block text-muted">
              Scheduled: {{ task.operation }} at {{ task.dateTime | date:'short' }}
            </small>
          </div>

        </div>

        <button class="btn btn-outline-danger position-absolute top-0 end-0 m-2 btn-sm"
                (click)="deleteVm(vm.id)">Delete
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Operation Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1" aria-labelledby="scheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="scheduleModalLabel">Schedule Operation for {{ selectedVm?.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label class="form-label">Operation</label>
            <div>
              <div class="form-check" *ngFor="let op of operations">
                <input class="form-check-input"
                       type="radio"
                       name="operation"
                       [value]="op"
                       [(ngModel)]="selectedOperation"
                       [id]="op">
                <label class="form-check-label" [for]="op">{{ op }}</label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Date and Time</label>
            <input type="datetime-local"
                   class="form-control"
                   [(ngModel)]="selectedDateTime"
                   name="dateTime">
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="scheduleOperation()">Schedule</button>
      </div>
    </div>
  </div>
</div>

